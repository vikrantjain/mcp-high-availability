global
    log stdout format raw local0
    maxconn 4096

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  redispatch
    retries 3
    retry-on all-retryable-errors
    timeout connect 5s
    timeout client  300s
    timeout server  300s
    timeout tunnel  600s

frontend mcp_frontend
    bind *:8080
    default_backend mcp_servers

frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s

backend mcp_servers
    balance leastconn

    # Sticky session table keyed by mcp-session-id header
    stick-table type string len 64 size 100k expire 30m

    # On first request (no session ID yet): round-robin picks a backend.
    # Learn the session ID from the response header and bind it to this backend.
    stick store-response res.hdr(mcp-session-id)

    # On subsequent requests: match the session ID from the request header
    # to route to the same backend.
    stick match req.hdr(mcp-session-id)

    option httpchk GET /health
    http-check expect status 200

    server mcp-server-1 mcp-server-1:8000 check inter 5s fall 3 rise 2
    server mcp-server-2 mcp-server-2:8000 check inter 5s fall 3 rise 2
    server mcp-server-3 mcp-server-3:8000 check inter 5s fall 3 rise 2
